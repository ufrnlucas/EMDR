<!DOCTYPE html>
<html>
<head>
    <title>Dispositivo EMDR - Web BLE App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Estilos Responsivos */
        body { font-family: Arial, sans-serif; margin: 10px; background-color: #f4f4f9; color: #333; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 15px; }
        input[type="number"], select, button { width: 100%; box-sizing: border-box; padding: 10px; margin: 8px 0; border-radius: 5px; }
        button { border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        #connectBleButton { background-color: #28a745; color: white; }
        #disconnectBleButton { background-color: #dc3545; color: white; }
        #startButton { background-color: #ffc107; color: #333; font-size: 1.2em; }
        #stopButton { background-color: #6c757d; color: white; font-size: 1.2em; }
        #bleState { font-size: 1.1em; }
        .note { font-size: 0.8em; color: #666; }
        input[type="range"] { margin: 5px 0 5px 0; width: calc(100% - 70px); }
        #intensityValue { display: inline-block; width: 60px; text-align: right; font-weight: bold; }

        @media (min-width: 600px) {
            body { max-width: 800px; margin: 20px auto; }
            input[type="number"], input[type="text"], select { width: 300px; display: inline-block; }
            #connectBleButton, #disconnectBleButton { width: auto; display: inline-block; }
            #startButton, #stopButton { width: 48%; display: inline-block; }
            input[type="range"] { width: 280px; }
        }
    </style>
</head>
<body>
    <h1>Dispositivo EMDR via Web Bluetooth</h1>
    <button id="connectBleButton">Conectar ao Dispositivo</button>
    <button id="disconnectBleButton">Desconectar</button>
    <p>Status BLE: <strong><span id="bleState" style="color:#dc3545;">Desconectado</span></strong></p>

    <hr>

    <h2>1. Configuração da Estimulação</h2>
    
    <label for="profileSelector">Selecione o Perfil a Configurar:</label>
    <select id="profileSelector">
        <option value="">-- Selecione um Perfil --</option>
        <option value="1" data-duration="1000" data-intensity="100">Perfil 1 (Padrão)</option>
        <option value="2" data-duration="2000" data-intensity="80">Perfil 2 (Lento)</option>
        <option value="3" data-duration="500" data-intensity="50">Perfil 3 (Rápido)</option>
        <option value="4" data-duration="1500" data-intensity="30">Perfil 4 (Suave)</option>
        <option value="5" data-duration="800" data-intensity="90">Perfil 5 (Forte)</option>
    </select>
    <br><br>

    <label for="durationInput">Duração de Vibração por Lado (ms):</label>
    <input type="number" id="durationInput" min="100" max="10000" value="">
    <p class="note">Mín: 100ms, Máx: 10000ms (10s).</p>
    
    <label for="intensityInput">Intensidade (0-100%):</label>
    <input type="range" id="intensityInput" min="0" max="100" value="0" oninput="intensityValue.value=intensityInput.value + '%'">
    <output id="intensityValue">0%</output>
    <p>Use a seleção de Perfil ou ajuste manualmente os controles acima.</p>
    <hr>

    <h2>2. Controle e Início da Estimulação</h2>

    <button id="startButton">INICIAR Vibração Síncrona</button>
    <button id="stopButton">PARAR Vibração</button>

    <p>Configuração Ativa: <strong><span id="valueSent">Nenhuma (Desconectado)</span></strong></p>

</body>
<script>
    // ************************************************************
    // 1. VARIÁVEIS E DOM
    // ************************************************************
    
    // VARIÁVEIS BLE (UUIDS ORIGINAIS E NOME FUNCIONAL)
    var deviceName ='ESP32'; 
    var bleService = '19b10000-e8f2-537e-4f6c-d104768a1214'; 
    var commandCharacteristic = '19b10002-e8f2-537e-4f6c-d104768a1214'; 
    var sensorCharacteristic= '19b10001-e8f2-537e-4f6c-d104768a1214'; 

    // Variáveis DOM
    const connectButton = document.getElementById('connectBleButton');
    const disconnectButton = document.getElementById('disconnectBleButton');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const durationInput = document.getElementById('durationInput');
    const intensityInput = document.getElementById('intensityInput');
    const intensityValue = document.getElementById('intensityValue');
    const profileSelector = document.getElementById('profileSelector');
    const latestValueSent = document.getElementById('valueSent');
    const bleStateContainer = document.getElementById('bleState');
    
    // Variáveis Globais de Conexão
    var bleServer;
    var bleServiceFound;
    var commandCharacteristicFound;
    var sensorCharacteristicFound;


    // ************************************************************
    // 2. LÓGICA DE PERFIS
    // ************************************************************

    function loadSelectedProfile() {
        const selectedOption = profileSelector.options[profileSelector.selectedIndex];
        
        if (selectedOption.value) {
            const duration = selectedOption.getAttribute('data-duration');
            const intensity = selectedOption.getAttribute('data-intensity');

            durationInput.value = duration;
            intensityInput.value = intensity;
            intensityValue.value = intensity + '%';
        }
    }
    profileSelector.addEventListener('change', loadSelectedProfile);

    // ************************************************************
    // 3. MAPEAMENTO E EVENTOS DE CONTROLE
    // ************************************************************

    // Mapeia o valor de intensidade de 0-100 para a faixa segura de 5-80 (real)
    function mapIntensity(userInput) {
        userInput = Math.max(0, Math.min(100, userInput));
        
        const outputMin = 5;
        const outputMax = 80;
        const inputMax = 100;

        // Fórmula: (x / B) * (D - C) + C
        const mappedValue = (userInput / inputMax) * (outputMax - outputMin) + outputMin;
        
        // O comando 0 (PARAR) deve sempre enviar Intensidade 0.
        if (userInput === 0) return 0;
        
        return Math.round(mappedValue);
    }


    connectButton.addEventListener('click', (event) => {
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });
    disconnectButton.addEventListener('click', disconnectDevice);

    startButton.addEventListener('click', () => {
        const duration = parseInt(durationInput.value);
        const intensity = parseInt(intensityInput.value);
        
        if (isNaN(duration) || isNaN(intensity) || !bleServer || !bleServer.connected) {
            alert("Verifique a Duração, Intensidade e a Conexão BLE.");
            return;
        }
        writeConfigCharacteristic(duration, intensity, 1);
    });

    stopButton.addEventListener('click', () => {
        writeConfigCharacteristic(0, 0, 0); 
    });


    // Função para enviar o comando como string (CSV: "Duração,Intensidade,Comando")
    function writeConfigCharacteristic(durationMs, intensity, command){
        if (commandCharacteristicFound && bleServer && bleServer.connected) {
            
            let intensityToSend = intensity;

            // *** APLICA O MAPEAMENTO DE INTENSIDADE PARA ESTABILIZAR O MOTOR ***
            if (command === 1) {
                intensityToSend = mapIntensity(intensity);
            }
            
            // 1. CONVERTE PARA STRING SIMPLES (CSV)
            const dataString = `${durationMs},${intensityToSend},${command}`;
            
            // Converte a string em ArrayBuffer para envio via BLE
            return commandCharacteristicFound.writeValue(new TextEncoder().encode(dataString))
            .then(() => {
                const status = command === 1 ? "INICIADO" : "PARADO";
                // Exibe a intensidade do USUÁRIO e a real para feedback completo
                const sentText = `Status: ${status}, Duração: ${durationMs}ms, Int. Usuário: ${intensity}%, Int. Real: ${intensityToSend}%`;
                latestValueSent.innerHTML = sentText;
                latestValueSent.style.color = command === 1 ? '#007bff' : '#333';
            })
            .catch(error => {
                alert("Erro ao enviar comando. Reconecte: " + error.message);
                console.error("Error writing to characteristic: ", error);
            });
        } else {
            window.alert("Bluetooth is not connected. \n Conecte ao BLE primeiro!")
        }
    }

    // ************************************************************
    // 4. LEITURA DE FEEDBACK NA CONEXÃO
    // ************************************************************

    function readActiveConfig() {
        if (!sensorCharacteristicFound) return Promise.resolve();

        // Esta função lê o último estado do ESP32 (4 bytes)
        return sensorCharacteristicFound.readValue()
            .then(value => {
                // A decodificação binária é complexa, mas vamos ler o buffer para feedback
                if (value.byteLength >= 4) {
                    const dataView = new DataView(value.buffer);
                    
                    // Os valores são lidos na ordem correta da struct C (uint16_t, uint8_t, uint8_t)
                    const durationMs = dataView.getUint16(0, true); // Little-Endian
                    const intensityReal = dataView.getUint8(2);
                    const command = dataView.getUint8(3);
                    
                    // CRÍTICO: Inverter o mapeamento para mostrar o valor que o USUÁRIO entende (0-100)
                    let intensityUser = Math.round(((intensityReal - 5) / (80 - 5)) * 100);
                    if (intensityReal === 0) intensityUser = 0; // Se o real for 0, o usuário vê 0
                    if (intensityUser < 0 || intensityUser > 100) intensityUser = 100; // Limites de segurança

                    // 1. Atualiza os inputs do Site
                    durationInput.value = durationMs;
                    intensityInput.value = intensityUser;
                    intensityValue.value = intensityUser + '%';
                    
                    // 2. Atualiza o Status de Atividade
                    const status = command === 1 ? "VIBRANDO" : "PARADO";
                    const sentText = `Lido do ESP32 (Ativo): Status: ${status}, Duração: ${durationMs}ms, Int. Usuário: ${intensityUser}%`;
                    latestValueSent.innerHTML = sentText;
                    latestValueSent.style.color = command === 1 ? '#007bff' : '#333';
                }
            })
            .catch(error => {
                console.error("Falha ao ler a característica de status:", error);
                latestValueSent.innerHTML = "Falha na leitura inicial. Usando 0ms/0%.";
            });
    }

    // ************************************************************
    // 5. FUNÇÕES DE CONEXÃO BLE
    // ************************************************************

    function connectToDevice(){
        navigator.bluetooth.requestDevice({
            filters: [{name: deviceName}],
            optionalServices: [bleService]
        })
        .then(device => {
            bleStateContainer.innerHTML = 'Conectado a ' + device.name;
            bleStateContainer.style.color = "#24af37";
            device.addEventListener('gattservicedisconnected', onDisconnected);
            return device.gatt.connect();
        })
        .then(gattServer =>{
            bleServer = gattServer;
            return bleServer.getPrimaryService(bleService);
        })
        .then(service => {
            bleServiceFound = service;
            // 1. Obtém a Característica de Comando (Escrita)
            return bleServiceFound.getCharacteristic(commandCharacteristic); 
        })
        .then(charCommand => {
            commandCharacteristicFound = charCommand;
            // 2. Obtém a Característica de Status (Leitura/Feedback)
            return bleServiceFound.getCharacteristic(sensorCharacteristic); 
        })
        .then(charStatus => {
            sensorCharacteristicFound = charStatus;
            // 3. Lê o estado ativo do ESP32 e atualiza a UI
            return readActiveConfig();
        })
        .catch(error => {
            alert("Erro de Conexão ou Serviço. Verifique o console: " + error.message);
            bleStateContainer.innerHTML = "Falha na Conexão";
            bleStateContainer.style.color = "#dc3545";
            console.error(error);
        })
    }

    function onDisconnected(event){
        bleStateContainer.innerHTML = "Dispositivo Desconectado";
        latestValueSent.innerHTML = "Nenhuma (Desconectado)"; 
        durationInput.value = 0; 
        intensityInput.value = 0;
        intensityValue.value = "0%";
        bleStateContainer.style.color = "#dc3545";
    }

    function disconnectDevice() {
        if (bleServer && bleServer.connected) {
            bleServer.disconnect();
        } else {
            window.alert("Bluetooth já está desconectado.")
        }
    }
    
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
            bleStateContainer.innerHTML = "Web Bluetooth API indisponível!";
            return false
        }
        return true
    }
</script>
</html>